name: Test Database Migrations

on:
    push:
        paths:
            - "**.py"
            - "app/.github/workflows/test-database-migrations.yml"
    pull_request:
        paths:
            - "**.py"
            - "uv.lock"
            - "pyproject.toml"
            - "app/.github/workflows/test-database-migrations.yml"

jobs:
    test-sqlite:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=sqlite+aiosqlite:///./test.db" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests
              run: make test

    test-postgres:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:latest
                env:
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: testdb
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/testdb" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests
              run: make test

    test-timescaledb:
        runs-on: ubuntu-latest
        services:
            timescaledb:
                image: timescale/timescaledb:latest-pg17
                env:
                    POSTGRES_PASSWORD: timescale
                    POSTGRES_DB: testdb
                ports:
                    - 5433:5432
                options: >-
                    --health-cmd="pg_isready"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=postgresql+asyncpg://postgres:timescale@localhost:5433/testdb" >> $GITHUB_ENV
                  echo "NATS_ENABLED=1" >> $GITHUB_ENV
                  echo "NATS_URL=nats://localhost:4222" >> $GITHUB_ENV
                  echo "MULTI_WORKER=1" >> $GITHUB_ENV
                  echo "UVICORN_WORKERS=2" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Start NATS (JetStream)
              run: |
                  docker run -d --name nats -p 4222:4222 nats:2.10-alpine -js
                  for i in {1..20}; do
                    nc -z 127.0.0.1 4222 && exit 0
                    sleep 0.5
                  done
                  echo "NATS did not start in time" >&2
                  exit 1

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests (multi-worker)
              run: |
                  NODE_ROLE=node-worker RUN_SCHEDULER=1 uv run python node_worker.py &
                  NODE_ROLE=scheduler RUN_SCHEDULER=1 uv run python scheduler_worker.py &
                  sleep 5
                  make test

    test-mysql:
        runs-on: ubuntu-latest
        services:
            mysql:
                image: mysql:latest
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: testdb
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -hlocalhost -uroot -proot"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=mysql+asyncmy://root:root@localhost:3306/testdb" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests
              run: make test

    test-mariadb:
        runs-on: ubuntu-latest
        services:
            mariadb:
                image: mariadb:10.6
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: testdb
                    MYSQL_USER: testuser
                    MYSQL_PASSWORD: testpassword
                ports:
                    - 3307:3306
                options: >-
                    --health-cmd "mysqladmin ping -h localhost -u testuser --password=testpassword"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=mysql+asyncmy://testuser:testpassword@localhost:3307/testdb" >> $GITHUB_ENV
                  echo "NATS_ENABLED=1" >> $GITHUB_ENV
                  echo "NATS_URL=nats://localhost:4222" >> $GITHUB_ENV
                  echo "MULTI_WORKER=1" >> $GITHUB_ENV
                  echo "UVICORN_WORKERS=2" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Start NATS (JetStream)
              run: |
                  docker run -d --name nats -p 4222:4222 nats:2.10-alpine -js
                  for i in {1..20}; do
                    nc -z 127.0.0.1 4222 && exit 0
                    sleep 0.5
                  done
                  echo "NATS did not start in time" >&2
                  exit 1

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests (multi-worker)
              run: |
                  NODE_ROLE=node-worker RUN_SCHEDULER=1 uv run python node_worker.py &
                  NODE_ROLE=scheduler RUN_SCHEDULER=1 uv run python scheduler_worker.py &
                  sleep 5
                  make test
