name: Test Database Migrations

on:
    push:
        paths:
            - "**.py"
            - ".github/workflows/test-database-migrations.yml"
    pull_request:
        paths:
            - "**.py"
            - "uv.lock"
            - "pyproject.toml"
            - ".github/workflows/test-database-migrations.yml"

jobs:
    test-sqlite:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "TESTING=1" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=sqlite+aiosqlite:///./test.db" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests
              run: make test

    test-postgres:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:latest
                env:
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: testdb
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "TESTING=1" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/testdb" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests
              run: make test

    test-timescaledb:
        runs-on: ubuntu-latest
        services:
            timescaledb:
                image: timescale/timescaledb:latest-pg17
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: testdb
                    POSTGRES_HOST_AUTH_METHOD: trust
                ports:
                    - 5433:5432
                options: >-
                    --health-cmd="pg_isready"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
            nats:
                image: nats:2.10-alpine
                ports:
                    - 4222:4222
                    - 8222:8222
                volumes:
                    - ${{ github.workspace }}/.github/nats/nats-server.conf:/etc/nats/nats-server.conf
                options: >-
                    --health-cmd="wget -q -O- http://127.0.0.1:8222/healthz || exit 1"
                    --health-interval=5s
                    --health-timeout=5s
                    --health-retries=20
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "TESTING=1" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5433/testdb" >> $GITHUB_ENV
                  echo "NATS_ENABLED=1" >> $GITHUB_ENV
                  echo "NATS_URL=nats://localhost:4222" >> $GITHUB_ENV
                  echo "UVICORN_WORKERS=2" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Wait for TimescaleDB
              run: |
                  uv run python - <<'PY'
                  import os
                  import time
                  import psycopg
                  from sqlalchemy.engine import make_url

                  url = make_url(os.environ["SQLALCHEMY_DATABASE_URL"])
                  dsn = str(url.set(drivername="postgresql"))

                  for _ in range(30):
                      try:
                          with psycopg.connect(dsn):
                              print("TimescaleDB is ready.")
                              break
                      except Exception as exc:
                          print(f"Waiting for TimescaleDB: {exc}")
                          time.sleep(1)
                  else:
                      raise SystemExit("TimescaleDB did not become ready in time.")
                  PY

            - name: Wait for NATS JetStream + KV
              run: |
                  uv run python - <<'PY'
                  import asyncio
                  import os
                  import time
                  import nats

                  url = os.environ["NATS_URL"]

                  async def probe():
                      nc = await nats.connect(url)
                      js = nc.jetstream()
                      try:
                          kv = await js.create_key_value(bucket="ci_probe_admin_auth")
                      except Exception:
                          kv = await js.key_value(bucket="ci_probe_admin_auth")
                      await kv.put("health", b"ok")
                      entry = await kv.get("health")
                      assert entry and entry.value == b"ok"
                      await kv.delete("health")
                      await nc.close()

                  for _ in range(40):
                      try:
                          asyncio.run(probe())
                          print("NATS JetStream KV is ready.")
                          break
                      except Exception as exc:
                          print(f"Waiting for NATS JetStream KV: {exc}")
                          time.sleep(1)
                  else:
                      raise SystemExit("NATS JetStream KV did not become ready in time.")
                  PY

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests (multi-worker)
              run: |
                  SCHEDULER_JOBSTORE_URL=sqlite:///./node-scheduler.db ROLE=node uv run python node_worker.py &
                  SCHEDULER_JOBSTORE_URL=sqlite:///./scheduler.db ROLE=scheduler uv run python scheduler_worker.py &
                  sleep 5
                  make test

    test-mysql:
        runs-on: ubuntu-latest
        services:
            mysql:
                image: mysql:latest
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: testdb
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -hlocalhost -uroot -proot"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "TESTING=1" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=mysql+asyncmy://root:root@localhost:3306/testdb" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests
              run: make test

    test-mariadb:
        runs-on: ubuntu-latest
        services:
            mariadb:
                image: mariadb:10.6
                env:
                    MARIADB_ROOT_HOST: "%"
                    MARIADB_ROOT_PASSWORD: root
                    MARIADB_DATABASE: testdb
                    MARIADB_USER: testuser
                    MARIADB_PASSWORD: testpassword
                ports:
                    - 3307:3306
                options: >-
                    --health-cmd "mysqladmin ping -h localhost -u testuser --password=testpassword"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
            nats:
                image: nats:2.10-alpine
                ports:
                    - 4222:4222
                    - 8222:8222
                volumes:
                    - ${{ github.workspace }}/.github/nats/nats-server.conf:/etc/nats/nats-server.conf
                options: >-
                    --health-cmd="wget -q -O- http://127.0.0.1:8222/healthz || exit 1"
                    --health-interval=5s
                    --health-timeout=5s
                    --health-retries=20
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Set DATABASE_URL
              run: |
                  echo "TEST_FROM=github" >> $GITHUB_ENV
                  echo "TESTING=1" >> $GITHUB_ENV
                  echo "SQLALCHEMY_DATABASE_URL=mysql+asyncmy://testuser:testpassword@localhost:3307/testdb" >> $GITHUB_ENV
                  echo "NATS_ENABLED=1" >> $GITHUB_ENV
                  echo "NATS_URL=nats://localhost:4222" >> $GITHUB_ENV
                  echo "UVICORN_WORKERS=2" >> $GITHUB_ENV

            - name: Install dependencies
              run: make setup

            - name: Wait for MariaDB and ensure testuser grants
              run: |
                  uv run python - <<'PY'
                  import time
                  import pymysql

                  params = {
                      "host": "127.0.0.1",
                      "port": 3307,
                      "user": "root",
                      "password": "root",
                      "database": "testdb",
                      "autocommit": True,
                  }

                  for _ in range(60):
                      try:
                          conn = pymysql.connect(**params)
                          break
                      except Exception as exc:
                          print(f"Waiting for MariaDB as root: {exc}")
                          time.sleep(1)
                  else:
                      raise SystemExit("MariaDB did not become ready in time.")

                  with conn.cursor() as cur:
                      cur.execute("DROP USER IF EXISTS 'testuser'@'%'")
                      cur.execute("DROP USER IF EXISTS 'testuser'@'localhost'")
                      cur.execute("CREATE USER 'testuser'@'%' IDENTIFIED BY 'testpassword'")
                      cur.execute("CREATE USER 'testuser'@'localhost' IDENTIFIED BY 'testpassword'")
                      cur.execute("GRANT ALL PRIVILEGES ON *.* TO 'testuser'@'%'")
                      cur.execute("GRANT ALL PRIVILEGES ON *.* TO 'testuser'@'localhost'")
                      cur.execute("FLUSH PRIVILEGES")
                      cur.execute("SELECT user, host, plugin FROM mysql.user WHERE user='testuser'")
                      print("Testuser entries:", cur.fetchall())
                  conn.close()
                  PY

            - name: Verify MariaDB connectivity as testuser
              run: |
                  uv run python - <<'PY'
                  import os
                  import pymysql
                  from sqlalchemy.engine import make_url

                  url = make_url(os.environ["SQLALCHEMY_DATABASE_URL"])
                  params = {
                      "host": url.host or "127.0.0.1",
                      "port": url.port or 3306,
                      "user": url.username,
                      "password": url.password,
                      "database": url.database,
                  }
                  params_native = params | {"client_flag": pymysql.constants.CLIENT.MULTI_STATEMENTS}
                  print("Connecting with params:", params_native)
                  try:
                      conn = pymysql.connect(**params_native)
                  except Exception as exc:
                      print("FAILED to connect with params:", params_native)
                      raise
                  with conn.cursor() as cur:
                      cur.execute("SELECT CURRENT_USER(), USER(), @@hostname")
                      print("User/host info:", cur.fetchone())
                      cur.execute("SHOW GRANTS")
                      print("Grants:", cur.fetchall())
                  conn.close()
                  PY

            - name: Wait for NATS JetStream + KV
              run: |
                  uv run python - <<'PY'
                  import asyncio
                  import os
                  import time
                  import nats

                  url = os.environ["NATS_URL"]

                  async def probe():
                      nc = await nats.connect(url)
                      js = nc.jetstream()
                      try:
                          kv = await js.create_key_value(bucket="ci_probe_admin_auth")
                      except Exception:
                          kv = await js.key_value(bucket="ci_probe_admin_auth")
                      await kv.put("health", b"ok")
                      entry = await kv.get("health")
                      assert entry and entry.value == b"ok"
                      await kv.delete("health")
                      await nc.close()

                  for _ in range(40):
                      try:
                          asyncio.run(probe())
                          print("NATS JetStream KV is ready.")
                          break
                      except Exception as exc:
                          print(f"Waiting for NATS JetStream KV: {exc}")
                          time.sleep(1)
                  else:
                      raise SystemExit("NATS JetStream KV did not become ready in time.")
                  PY

            - name: Run Alembic Migrations
              run: make run-migration

            - name: Run Tests (multi-worker)
              run: |
                  SCHEDULER_JOBSTORE_URL=mysql+asyncmy://testuser:testpassword@localhost:3307/testdb ROLE=node uv run python node_worker.py &
                  SCHEDULER_JOBSTORE_URL=mysql+asyncmy://testuser:testpassword@localhost:3307/testdb ROLE=scheduler uv run python scheduler_worker.py &
                  sleep 5
                  make test
