"""add general settings to app

Revision ID: 8fe407cf56c9
Revises: 3c466ce2ab63
Create Date: 2025-07-08 15:48:02.163498

"""
import json
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '8fe407cf56c9'
down_revision = '3c466ce2ab63'
branch_labels = None
depends_on = None


def upgrade():
    bind = op.get_bind()
    dialect = bind.dialect.name

    # Step 1: Add nullable column using batch_op
    with op.batch_alter_table('settings') as batch_op:
        batch_op.add_column(
            sa.Column('general', sa.JSON(), nullable=True)
        )

    # Step 2: Backfill with default JSON value
    default_value = {
        "default_flow": "",
        "default_method": "chacha20-ietf-poly1305"
    }
    default_str = json.dumps(default_value)
    op.execute(f"UPDATE settings SET general = '{default_str}'")

    # Step 3: Make column non-nullable (only if not SQLite)
    with op.batch_alter_table('settings') as batch_op:
        batch_op.alter_column('general',existing_type=sa.JSON(), type_=sa.JSON(), nullable=False)

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('settings', 'general')
    # ### end Alembic commands ###
